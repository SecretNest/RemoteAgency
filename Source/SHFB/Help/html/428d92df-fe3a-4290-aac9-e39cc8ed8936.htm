<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-en-US.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>9 Event with multiple clients</title><meta name="Language" content="en-us" /><meta name="Microsoft.Help.Id" content="428d92df-fe3a-4290-aac9-e39cc8ed8936" /><meta name="Description" content="This example is based on example 8, but" /><meta name="Microsoft.Help.ContentType" content="How To" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script><script type="text/javascript" src="../scripts/clipboard.min.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Remote Agency<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="e572b781-93d2-4e52-afb1-8ce06607856b.htm" title="Remote Agency" tocid="roottoc">Remote Agency</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="2fe3f60f-7261-4cb5-826b-b84bfeab6a3e.htm" title="How to" tocid="2fe3f60f-7261-4cb5-826b-b84bfeab6a3e">How to</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c84610d8-63f7-48b7-aa35-3a66c03859a1.htm" title="Example: Use Remote Agency" tocid="c84610d8-63f7-48b7-aa35-3a66c03859a1">Example: Use Remote Agency</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="d4df62b1-2c8f-471a-bc08-931e0bb21b0a.htm" title="1 Hello World" tocid="d4df62b1-2c8f-471a-bc08-931e0bb21b0a">1 Hello World</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="222b9528-0832-45f0-9eff-b6fc496212cb.htm" title="2 Method with parameter, ref, out and return." tocid="222b9528-0832-45f0-9eff-b6fc496212cb">2 Method with parameter, ref, out and return.</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="9c0126a8-a683-4903-86f0-d7737e2ba575.htm" title="3 Method with two way property and overload." tocid="9c0126a8-a683-4903-86f0-d7737e2ba575">3 Method with two way property and overload.</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="fbcae2ec-4424-4fbb-82bb-0459c841eec5.htm" title="4 Generic method" tocid="fbcae2ec-4424-4fbb-82bb-0459c841eec5">4 Generic method</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="b087c8c6-40f9-41de-adc1-16c90ef8e25d.htm" title="5 Property" tocid="b087c8c6-40f9-41de-adc1-16c90ef8e25d">5 Property</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="d33e44c6-26cb-4396-880d-dfd3bb4783b1.htm" title="6 Multiple contracts" tocid="d33e44c6-26cb-4396-880d-dfd3bb4783b1">6 Multiple contracts</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="824b7af8-08c6-493d-b694-e05bfe64b753.htm" title="7 Event" tocid="824b7af8-08c6-493d-b694-e05bfe64b753">7 Event</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="94ec2756-b127-468a-8c6f-ce18bbefbafb.htm" title="8 Advanced event" tocid="94ec2756-b127-468a-8c6f-ce18bbefbafb">8 Advanced event</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="428d92df-fe3a-4290-aac9-e39cc8ed8936.htm" title="9 Event with multiple clients" tocid="428d92df-fe3a-4290-aac9-e39cc8ed8936">9 Event with multiple clients</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="Click or drag to resize" title="Click or drag to resize" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="Click or drag to resize" title="Click or drag to resize" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="logoColumn"><img src="../icons/Help.png" /></td><td class="titleColumn"><h1>9 Event with multiple clients</h1></td></tr></table><span class="introStyle"></span> <div class="introduction"><p>This example is based on example 8, but</p><ul><li><p>Two clients on two different sites are involved;</p></li><li><p>Changed to use standard RemoteAgency and Data Contract Serializer instead of EasyEncapsulation used in other examples; and,</p></li><li><p>Dealing with assembly cache.</p></li></ul></div><h3 class="procedureSubHeading">Event with multiple clients</h3><div class="subSection"><ol><li><p>Create a Console Application (.NET Core) in Visual Studio or other IDE.</p><p>(Caution: .Net Framework is not supported.)</p><p>Due to only C# is supported language in .Net Core at the moment, all examples are provided only in C#.</p></li><li><p>Add SecretNest.RemoteAgency and SecretNest.RemoteAgency.DataContractSerializer from Nuget.</p></li><li><p>Define a service contract interface and the delegate, create the service class like in Example 8.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAANBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAANBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAANBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAANBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">public</span> <span class="highlight-keyword">delegate</span> <span class="highlight-keyword">string</span> MyTestHandler(<span class="highlight-keyword">string</span> <span class="highlight-keyword">value</span>);

<span class="highlight-comment">//[ProxyCacheable]</span>
<span class="highlight-keyword">public</span> <span class="highlight-keyword">interface</span> IHello
{
  [EventParameterIgnored(<span class="highlight-literal">"sender"</span>)]
  <span class="highlight-keyword">event</span> EventHandler WorldOpened;

  <span class="highlight-keyword">event</span> MyTestHandler MyTestEvent;
  <span class="highlight-keyword">void</span> HelloWorld();
}

<span class="highlight-keyword">class</span> Hello : IHello
{
  <span class="highlight-keyword">public</span> <span class="highlight-keyword">event</span> EventHandler WorldOpened;
  <span class="highlight-keyword">public</span> <span class="highlight-keyword">event</span> MyTestHandler MyTestEvent;

  <span class="highlight-keyword">public</span> <span class="highlight-keyword">void</span> HelloWorld()
  {
    WorldOpened?.Invoke(<span class="highlight-keyword">this</span>, EventArgs.Empty);

    <span class="highlight-keyword">string</span> <span class="highlight-keyword">value</span> = MyTestEvent?.Invoke(<span class="highlight-literal">"Request"</span>);
    <span class="highlight-keyword">if</span> (<span class="highlight-keyword">value</span> == <span class="highlight-literal">"Response"</span>)
      Console.WriteLine(<span class="highlight-literal">"Pass."</span>);
  }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAANBDAAA");</script></li><li><p>Add "using"s to the top.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAMBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAMBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAMBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAMBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">using</span> System;
<span class="highlight-keyword">using</span> System.Collections.Generic;
<span class="highlight-keyword">using</span> System.Threading.Tasks;
<span class="highlight-keyword">using</span> SecretNest.RemoteAgency;
<span class="highlight-keyword">using</span> SecretNest.RemoteAgency.Attributes;
<span class="highlight-keyword">using</span> System.Collections.Concurrent;
<span class="highlight-keyword">using</span> System.Reflection;
<span class="highlight-keyword">using</span> System.IO;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAMBDAAA");</script></li><li><p>Declares the dictionary holding all managers of all sites in the top of class.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAALBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAALBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAALBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAALBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">static</span> Dictionary&lt;Guid, RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;&gt; sites = <span class="highlight-keyword">new</span> Dictionary&lt;Guid, RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;&gt;();</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAALBDAAA");</script></li><li><p>In Main method, define all helper objects.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAKBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAKBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAKBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAKBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">//3 helper provided by Data Contract Serializer</span>
DataContractSerializerEntityCodeBuilder entityCodeBuilder = <span class="highlight-keyword">new</span> DataContractSerializerEntityCodeBuilder();
DataContractSerializerSerializingHelper serializingHelper = <span class="highlight-keyword">new</span> DataContractSerializerSerializingHelper();
DataContractToJsonPackingHelper packingHelper = <span class="highlight-keyword">new</span> DataContractToJsonPackingHelper();

<span class="highlight-comment">//Create the proxy creator for creating proxy objects of client sites.</span>
ProxyCreator&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt; proxyCreator = <span class="highlight-keyword">new</span> ProxyCreator&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;(entityCodeBuilder, <span class="highlight-keyword">typeof</span>(DataContractSerializerSerializingHelper));

<span class="highlight-comment">//Create the service wrapper creator for creating service wrapper object of server site.</span>
ServiceWrapperCreator&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt; serviceWrapperCreator = <span class="highlight-keyword">new</span> ServiceWrapperCreator&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;(entityCodeBuilder, <span class="highlight-keyword">typeof</span>(DataContractSerializerSerializingHelper));</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAKBDAAA");</script></li><li><p>In Main method, define manager object for each site.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAJBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAJBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAJBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAJBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt; clientSite1 = <span class="highlight-keyword">new</span> RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;(packingHelper, serializingHelper);
RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt; clientSite2 = <span class="highlight-keyword">new</span> RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;(packingHelper, serializingHelper);
RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt; serverSite = <span class="highlight-keyword">new</span> RemoteAgencyManager&lt;<span class="highlight-keyword">string</span>, <span class="highlight-keyword">string</span>, <span class="highlight-keyword">object</span>&gt;(packingHelper, serializingHelper);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAJBDAAA");</script></li><li><p>Prepare the method for message sending in class. Asynchronous call is chosen for simulating the network environment.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EACAIBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EACAIBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EACAIBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EACAIBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">private</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">void</span> OnMessageForSendingPrepared(<span class="highlight-keyword">object</span> sender, RemoteAgencyManagerMessageForSendingEventArgs&lt;<span class="highlight-keyword">string</span>&gt; e)
{
  <span class="highlight-comment">//Async mode</span>
  Task.Run(() =&gt;
    sites[e.TargetSiteId].ProcessPackagedMessage(e.Message));
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EACAIBDAAA");</script><p>Add attach it to manager objects in Main method.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAIBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAIBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAIBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAIBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">clientSite1.MessageForSendingPrepared += OnMessageForSendingPrepared;
clientSite2.MessageForSendingPrepared += OnMessageForSendingPrepared;
serverSite.MessageForSendingPrepared += OnMessageForSendingPrepared;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAIBDAAA");</script></li><li><p>In Main method, set the site id of server as the default target of clients.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EABAHBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EABAHBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EABAHBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EABAHBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">clientSite1.DefaultTargetSiteId = serverSite.SiteId;
clientSite2.DefaultTargetSiteId = serverSite.SiteId;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EABAHBDAAA");</script><p>When client send a message out, a target need to be specified. Check the <a href="3484da6c-de69-4562-8f77-0d2c92b273b6.htm">target site management</a> for details.</p></li><li><p>In Main method, add manager objects to dictionary.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAGBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAGBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAGBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAGBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">sites.Add(clientSite1.SiteId, clientSite1);
sites.Add(clientSite2.SiteId, clientSite2);
sites.Add(serverSite.SiteId, serverSite);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAGBDAAA");</script></li><li><p>In Main method, change the status of manager objects to connected.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EABAFBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EABAFBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EABAFBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EABAFBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">clientSite1.Connect();
clientSite2.Connect();
serverSite.Connect();</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EABAFBDAAA");</script><p>Only connected manager object can handle the message sending. Check the <a href="ae682acd-f05a-4470-a25a-9c19ce4e4d16.htm">IO status</a> for details.
          </p></li><li><p>In Main method, define the service object, create a service wrapper and put it into server site.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EABAEBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EABAEBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EABAEBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EABAEBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">Hello serviceObject = <span class="highlight-keyword">new</span> Hello();
serverSite.AddServiceWrapper&lt;IHello&gt;(serviceWrapperCreator, serviceObject, <span class="highlight-keyword">out</span> Guid serviceWrapperInstanceId);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EABAEBDAAA");</script><p>Service Wrapper Creator is required for creating the service wrapper object.</p></li><li><p>Add methods for handling events for clients.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAADBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAADBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAADBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAADBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">private</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">void</span> Proxy_WorldOpened1(<span class="highlight-keyword">object</span> sender, EventArgs e)
{
  Console.WriteLine(<span class="highlight-literal">"Proxy1: Hello World!"</span>);
}

<span class="highlight-keyword">private</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">void</span> Proxy_WorldOpened2(<span class="highlight-keyword">object</span> sender, EventArgs e)
{
  Console.WriteLine(<span class="highlight-literal">"Proxy2: Hello World!"</span>);
}

<span class="highlight-keyword">private</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">string</span> Proxy_MyTestEvent(<span class="highlight-keyword">string</span> <span class="highlight-keyword">value</span>)
{
  <span class="highlight-keyword">if</span> (<span class="highlight-keyword">value</span> == <span class="highlight-literal">"Request"</span>)
    <span class="highlight-keyword">return</span> <span class="highlight-literal">"Response"</span>;
  <span class="highlight-keyword">else</span>
    <span class="highlight-keyword">return</span> <span class="highlight-literal">"Unknown"</span>;
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAADBDAAA");</script></li><li><p>In Main method, create proxy objects, put them into client sites, and add the handlers of events.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EABACBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EABACBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EABACBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EABACBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">IHello proxy1 = clientSite1.AddProxy&lt;IHello&gt;(proxyCreator, serviceWrapperInstanceId, <span class="highlight-keyword">out</span> <span class="highlight-keyword">var</span> proxyInstance1Id);
proxy1.WorldOpened += Proxy_WorldOpened1;
proxy1.MyTestEvent += Proxy_MyTestEvent;

IHello proxy2 = clientSite2.AddProxy&lt;IHello&gt;(proxyCreator, serviceWrapperInstanceId, <span class="highlight-keyword">out</span> <span class="highlight-keyword">var</span> proxyInstance2Id);
proxy2.WorldOpened += Proxy_WorldOpened2;
proxy2.MyTestEvent += Proxy_MyTestEvent;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EABACBDAAA");</script><p>Proxy Creator is required for creating the proxy object.</p></li><li><p>In Main method, call the method of proxy1.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAABBDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAABBDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAABBDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAABBDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">proxy1.HelloWorld();</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAABBDAAA");</script></li><li><p>Finalizing</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAAABDAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAAABDAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAAABDAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAAABDAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">Console.WriteLine(<span class="highlight-literal">"Finished."</span>);
Console.ReadKey(); <span class="highlight-comment">//Pause before quit.</span>
clientSite1.RemoveManagingObject(proxyInstance1Id, <span class="highlight-keyword">true</span>);
clientSite2.RemoveManagingObject(proxyInstance2Id, <span class="highlight-keyword">true</span>);
serverSite.RemoveManagingObject(serviceWrapperInstanceId, <span class="highlight-keyword">true</span>);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAAABDAAA");</script></li></ol></div><h3 class="procedureSubHeading">Dealing with assembly cache</h3><div class="subSection"><ol><li><p>Mark the interface [ProxyCacheable] (<a href="685234bc-fe7c-2116-b26f-e77172141a63.htm">ProxyCacheableAttribute</a>) for proxy caching</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EABADACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EABADACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EABADACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EABADACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"></pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EABADACAAA");</script><p>If you need service wrapper caching, mark [ServiceWrapperCacheable] (<a href="33debc4f-4f22-e585-2f88-e40ce1e0689b.htm">ServiceWrapperCacheableAttribute</a>) on the class of service.</p></li><li><p>In class level, prepare a dictionary for caching.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAACACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAACACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAACACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAACACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">static</span> ConcurrentDictionary&lt;Type, Tuple&lt;Assembly, <span class="highlight-keyword">bool</span>&gt;&gt; assemblyCache = <span class="highlight-keyword">new</span> ConcurrentDictionary&lt;Type, Tuple&lt;Assembly, <span class="highlight-keyword">bool</span>&gt;&gt;();</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAACACAAA");</script></li><li><p>Prepare a method for loading from cache in class level.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EACABACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EACABACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EACABACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EACABACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">static</span> Assembly LoadCachedAssembly(Type type, <span class="highlight-keyword">out</span> <span class="highlight-keyword">bool</span> disposeRequired)
{
  <span class="highlight-keyword">if</span> (assemblyCache.TryGetValue(type, <span class="highlight-keyword">out</span> <span class="highlight-keyword">var</span> item))
  {
    disposeRequired = item.Item2;
    <span class="highlight-keyword">return</span> item.Item1;
  }
  <span class="highlight-keyword">else</span>
  {
    disposeRequired = <span class="highlight-keyword">false</span>;
    <span class="highlight-keyword">return</span> <span class="highlight-keyword">null</span>;
  }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EACABACAAA");</script><p>And attach it to the creator in Main method.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAABACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAABACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAABACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAABACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">proxyCreator.LoadCachedAssemblyCallback = LoadCachedAssembly;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAABACAAA");</script></li><li><p>To save the created assembly to cache, you have 2 ways.</p><ul><li><p>If you just need to cache the assembly in memory, you can receive the assembly object directly.</p><p>Prepare a method for saving to cache in class level.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EACBBAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EACBBAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EACBBAAACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EACBBAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">static</span> <span class="highlight-keyword">void</span> SaveCachedAssembly(Type type, <span class="highlight-keyword">bool</span> disposeRequired, Assembly assembly)
{
    Tuple&lt;Assembly, <span class="highlight-keyword">bool</span>&gt; item = <span class="highlight-keyword">new</span> Tuple&lt;Assembly, <span class="highlight-keyword">bool</span>&gt;(assembly, disposeRequired);
    assemblyCache.AddOrUpdate(type, item, (i, j) =&gt; item);
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EACBBAAACAAA");</script><p>And attach it to the creator in Main method.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAABBAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAABBAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAABBAAACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAABBAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">proxyCreator.SaveCachedAssemblyCallback = SaveCachedAssembly;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAABBAAACAAA");</script></li><li><p>If you want to save the assembly to disk also, you may want to get the byte array of the assembly.</p><p>Add nuget package for creating assembly from byte arary, named System.Runtime.Loader.</p><p>Prepare a method for saving to cache in class level.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EACABAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EACABAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EACABAAACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EACABAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">Assembly assembly;
<span class="highlight-keyword">using</span> (MemoryStream ms = <span class="highlight-keyword">new</span> MemoryStream(image))
{
  assembly = System.Runtime.Loader.AssemblyLoadContext.Default.LoadFromStream(ms);
}
Tuple&lt;Assembly, <span class="highlight-keyword">bool</span>&gt; item = <span class="highlight-keyword">new</span> Tuple&lt;Assembly, <span class="highlight-keyword">bool</span>&gt;(assembly, disposeRequired);
assemblyCache.AddOrUpdate(type, item, (i, j) =&gt; item);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EACABAAACAAA");</script><p>And attach it to the creator in Main method.</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EAAABAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EAAABAAACAAA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EAAABAAACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EAAABAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">proxyCreator.SaveCachedAssemblyImageCallback = SaveCachedAssemblyImage;</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EAAABAAACAAA");</script></li></ul><p>You can use these 2 ways combined also.</p></li></ol></div><div class="collapsibleAreaRegion"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID1RB')" onkeypress="SectionExpandCollapse_CheckKey('ID1RB', event)" tabindex="0"><img id="ID1RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />Source code package</span></div><div id="ID1RBSection" class="collapsibleSection"><p>
          All examples can code can be fetched on <a href="https://github.com/scegg/RemoteAgency" target="_blank">Github</a>.
        </p><p>
          Code file of this example: <a href="https://github.com/scegg/RemoteAgency/blob/master/Examples/CSharpExample/Example%209/Program.cs" target="_blank">Github C#</a></p></div><div class="collapsibleAreaRegion" id="seeAlsoSection"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />See Also</span></div><div id="ID2RBSection" class="collapsibleSection"><h4 class="subHeading">Other Resources</h4><div class="seeAlsoStyle"><a href="94ec2756-b127-468a-8c6f-ce18bbefbafb.htm">8 Advanced event</a></div></div></div></div><div id="pageFooter" class="pageFooter" /></body></html>